<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>nginx_dtrace_pid_provider-nginx中文手册</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="None"/>
<meta name="keywords" content="request,ngx,http,line,process"/>
</head>
<body>
<div id="content"><h2>  使用DTrace pid提供程序调试nginx </h2><p>  本文假设读者具有nginx内部和<a href="#see_also">DTrace</a>的一般知识。 </p><p>  尽管使用<a href="debugging_log.html">--with-debug</a>选项构建的nginx已经提供了大量有关请求处理的信息，但有时需要更彻底地跟踪代码路径的特定部分，同时省略其余的调试输出。   DTrace pid提供程序（在Solaris，macOS上提供）是一个用于探索userland程序内部的有用工具，因为它不需要任何代码更改，它可以帮助完成任务。  用于跟踪和打印nginx函数调用的简单DTrace脚本可能如下所示： </p><blockquote class="example"><pre class="notranslate">#pragma D option flowindent

pid$target:nginx::entry {
}

pid$target:nginx::return {
}
</pre></blockquote><p></p><p>  但是，函数调用跟踪的DTrace功能仅提供有限的有用信息。  函数参数的实时检查通常更有趣，但也更复杂一些。  以下示例旨在帮助读者更熟悉DTrace以及使用DTrace分析nginx行为的过程。 </p><p>  将DTrace与nginx一起使用的常见方案之一如下：附加到nginx工作进程以记录请求行和请求开始时间。  要附加的相应函数是<code class="notranslate">ngx_http_process_request()</code> ，所讨论的参数是指向<code class="notranslate">ngx_http_request_t</code>结构的指针。  用于此类请求记录的DTrace脚本可以如下所示： </p><blockquote class="example"><pre class="notranslate">pid$target::*ngx_http_process_request:entry
{
    this-&gt;request = (ngx_http_request_t *)copyin(arg0, sizeof(ngx_http_request_t));
    this-&gt;request_line = stringof(copyin((uintptr_t)this-&gt;request-&gt;request_line.data,
                                         this-&gt;request-&gt;request_line.len));
    printf("request line = %s\n", this-&gt;request_line);
    printf("request start sec = %d\n", this-&gt;request-&gt;start_sec);
}
</pre></blockquote><p></p><p>  应该注意的是，在上面的示例中，DTrace需要一些关于<code class="notranslate">ngx_http_process_request</code>结构的知识。  不幸的是，虽然可以在DTrace脚本中使用特定的<code class="notranslate">#include</code>指令，然后将其传递给C预处理器（带有<code class="notranslate">-C</code>标志），但这并不能真正起作用。  由于存在大量的交叉依赖性，因此几乎所有的nginx头文件都必须包含在内。  反过来，基于<code class="notranslate">configure</code>脚本设置，nginx标头将包括PCRE，OpenSSL和各种系统头文件。  虽然理论上所有与特定nginx构建相关的头文件都可能包含在DTrace脚本预处理和编译中，但实际上DTrace脚本很可能由于某些头文件中的语法未知而无法编译。 </p><p>  上述问题可以通过在DTrace脚本中仅包含相关且必要的结构和类型定义来解决。   DTrace必须知道结构，类型和字段偏移的大小。  因此，可以通过手动优化用于DTrace的结构定义来进一步减少依赖性。 </p><p>  让我们使用上面的DTrace脚本示例，看看它需要什么样的结构定义才能正常工作。 </p><p>  首先应该包括configure生成的<code class="notranslate">objs/ngx_auto_config.h</code>文件，因为它定义了一些影响各种<code class="notranslate">#ifdef</code>的常量。  之后， <code class="notranslate">ngx_table_elt_t</code>一些基本类型和定义（如<code class="notranslate">ngx_str_t</code> ， <code class="notranslate">ngx_table_elt_t</code> ， <code class="notranslate">ngx_uint_t</code>等）放在DTrace脚本的开头。  这些定义是紧凑的，常用且不太可能经常改变。 </p><p>  然后是<code class="notranslate">ngx_http_process_request_t</code>结构，其中包含许多指向其他结构的指针。  因为这些指针实际上与此脚本无关，并且因为它们具有相同的大小，所以可以用void指针替换它们。  不是更改定义，最好添加适当的typedef，但是： </p><blockquote class="example"><pre class="notranslate">typedef ngx_http_upstream_t     void;
typedef ngx_http_request_body_t void;
</pre></blockquote><p>  最后但并非最不重要的是，有必要添加两个成员结构的定义（ <code class="notranslate">ngx_http_headers_in_t</code> ， <code class="notranslate">ngx_http_headers_out_t</code> ），回调函数的声明和常量的定义。 </p><p>  最终的DTrace脚本可以从<a href="http://nginx.org/download/trace_process_request.d">这里</a>下载。 </p><p>  以下示例显示了运行此脚本的输出： </p><blockquote class="example"><pre class="notranslate"># dtrace -C -I ./objs -s trace_process_request.d -p 4848
dtrace: script 'trace_process_request.d' matched 1 probe
CPU     ID                    FUNCTION:NAME
  1      4 .XAbmO.ngx_http_process_request:entry request line = GET / HTTP/1.1
request start sec = 1349162898

  0      4 .XAbmO.ngx_http_process_request:entry request line = GET /en/docs/nginx_dtrace_pid_provider.html HTTP/1.1
request start sec = 1349162899
</pre></blockquote><p></p><p>  使用类似的技术，读者应该能够跟踪其他nginx函数调用。 </p><a name="see_also"></a><center><h4>  也可以看看 </h4></center><p></p><ul class="compact"><li>   <a href="http://docs.oracle.com/cd/E19253-01/817-6223/index.html">Solaris动态跟踪指南</a> </li><li>   <a href="http://dtrace.org/blogs/brendan/2011/02/09/dtrace-pid-provider/">有关DTrace pid提供程序的简介文章</a> </li></ul><p></p> 
<span></span><div style="display: none;"></div></div>
</body>
</html>