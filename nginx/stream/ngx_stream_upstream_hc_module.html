<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>stream/ngx_stream_upstream_hc_module-nginx中文手册</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="None"/>
<meta name="keywords" content="server,upstream,example,com,12345"/>
</head>
<body>
<div id="content"><h2 class="notranslate">Module ngx_stream_upstream_hc_module</h2><table width="100%"><tbody><tr><td align="left" class="notranslate"> <a href="#example">Example Configuration</a> <br> <a href="#directives">Directives</a> <br>     <a href="#health_check">health_check</a> <br>     <a href="#health_check_timeout">health_check_timeout</a> <br>     <a href="#match">match</a> <br></td></tr></tbody></table><a name="summary"></a><p>   <code class="notranslate">ngx_stream_upstream_hc_module</code>模块（1.9.0）允许对<a href="ngx_stream_upstream_module.html#upstream">组</a>中的服务器启用定期运行状况检查。  服务器组必须驻留在<a href="ngx_stream_upstream_module.html#zone">共享内存中</a> 。 </p><p>  如果运行状况检查失败，则服务器将被视为运行状况不佳。  如果为同一组服务器定义了多个运行状况检查，则任何检查的单个故障都将使相应的服务器被视为不健康。  客户端连接不会传递到处于“检查”状态的不健康服务器和服务器。 </p><p></p><blockquote class="note">  该模块作为我们<a href="http://nginx.com/products/">商业订阅的</a>一部分提供。 </blockquote><p></p><a name="example"></a><center><h4>  示例配置 </h4></center><p></p><blockquote class="example"><pre class="notranslate">upstream tcp {
    zone upstream_tcp 64k;

    server backend1.example.com:12345 weight=5;
    server backend2.example.com:12345 fail_timeout=5s slow_start=30s;
    server 192.0.2.1:12345            max_fails=3;

    server backup1.example.com:12345  backup;
    server backup2.example.com:12345  backup;
}

server {
    listen     12346;
    proxy_pass tcp;
    health_check;
}
</pre></blockquote><p>  使用此配置，nginx将检查每五秒钟与<code class="notranslate">tcp</code>组中每个服务器建立TCP连接的能力。  当无法建立与服务器的连接时，运行状况检查将失败，并且服务器将被视为运行状况不佳。 </p><p>  可以为UDP协议配置运行状况检查： </p><blockquote class="example"><pre class="notranslate">upstream dns_upstream {

    zone   dns_zone 64k;

    server dns1.example.com:53;
    server dns2.example.com:53;
    server dns3.example.com:53;
}

server {
    listen       53 udp;
    proxy_pass   dns_upstream;
    health_check udp;
}
</pre></blockquote><p>  在这种情况下，预期缺少ICMP“ <code class="notranslate">Destination Unreachable</code> ”消息以回复发送的字符串“ <code class="notranslate">nginx health check</code> ”。 </p><p>  还可以配置运行状况检查以测试从服务器获取的数据。  测试使用<a href="#match">match</a>伪指令单独配置，并在<a href="#health_check">health_check</a>指令的<code class="notranslate">match</code>参数中引用。 </p><a name="directives"></a><center><h4>  指令 </h4></center><a name="health_check"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>health_check</strong> [ <code class="notranslate"><i>parameters</i></code> ];</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            
            —
        
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">server</code> <br>
                </td></tr></tbody></table></div><p>  启用对<a href="ngx_stream_upstream_module.html#upstream">组中</a>服务器的定期运行状况检查。 </p><p>  支持以下可选参数： </p><dl class="compact"><dt id="health_check_interval">   <code class="notranslate">interval</code> = <code class="notranslate"><i>time</i></code> </dt><dd>  设置两次连续运行状况检查之间的间隔，默认为5秒。 </dd><dt id="health_check_jitter">   <code class="notranslate">jitter</code> = <code class="notranslate"><i>time</i></code> </dt><dd>  设置每个健康检查随机延迟的时间，默认情况下，没有延迟。 </dd><dt id="health_check_fails">   <code class="notranslate">fails</code> = <code class="notranslate"><i>number</i></code> </dt><dd>  设置特定服务器的连续失败运行状况检查的数量，在此之后，此服务器将被视为运行状况不佳，默认情况下为1。 </dd><dt id="health_check_passes">   <code class="notranslate">passes</code> = <code class="notranslate"><i>number</i></code> </dt><dd>  设置特定服务器的连续传递运行状况检查的数量，在此之后服务器将被视为运行状况，默认情况下为1。 </dd><dt id="health_check_mandatory"> <code class="notranslate">mandatory</code> </dt> <dd>  设置服务器的初始“检查”状态，直到第一次健康检查完成（1.11.7）。  客户端连接不会传递到处于“检查”状态的服务器。  如果未指定参数，则服务器最初将被视为健康。 </dd><dt id="health_check_match">   <code class="notranslate">match</code> = <code class="notranslate"><i>name</i></code> </dt><dd>  指定配置成功连接应传递的测试的<code class="notranslate">match</code>块，以便进行运行状况检查。  默认情况下，对于TCP，仅检查与服务器建立TCP连接的能力。  对于<a href="#health_check_udp">UDP</a> ，预期缺少ICMP“ <code class="notranslate">Destination Unreachable</code> ”消息以回复发送的字符串“ <code class="notranslate">nginx health check</code> ”。 <blockquote class="note">  在1.11.7版之前，默认情况下，UDP运行状况检查需要带有<a href="#match_send">send</a>和<a href="#match_expect">expect</a>参数的<a href="#hc_match">匹配</a>块。 </blockquote></dd><dt id="health_check_port">   <code class="notranslate">port</code> = <code class="notranslate"><i>number</i></code> </dt><dd>  定义连接到服务器以执行运行状况检查时使用的端口（1.9.7）。  默认情况下，等于<a href="ngx_stream_upstream_module.html#server">服务器</a>端口。 </dd><dt id="health_check_udp"> <code class="notranslate">udp</code> </dt> <dd>  指定<code class="notranslate">UDP</code>协议应该用于运行状况检查而不是默认的<code class="notranslate">TCP</code>协议（1.9.13）。 </dd></dl><p></p><a name="health_check_timeout"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>health_check_timeout</strong> <code class="notranslate"><i>timeout</i></code> ;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            <pre class="notranslate">health_check_timeout 5s;</pre>
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">stream</code> , <code class="notranslate">server</code> <br>
                </td></tr></tbody></table></div><p>  覆盖<a href="ngx_stream_proxy_module.html#proxy_timeout">运行</a>状况检查的<a href="ngx_stream_proxy_module.html#proxy_timeout">proxy_timeout</a>值。 </p><a name="match"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>match</strong> <code class="notranslate"><i>name</i></code>  { ... }</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            
            —
        
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">stream</code> <br>
                </td></tr></tbody></table></div><p>  定义用于验证服务器对运行状况检查的响应的命名测试集。 </p><p>  可以配置以下参数： </p><dl class="compact"><dt id="match_send">   <code class="notranslate">send</code> <code class="notranslate"><i>string</i></code> ; </dt><dd>  将<code class="notranslate"><i>string</i></code>发送到服务器; </dd><dt id="match_expect">   <code class="notranslate">expect</code> <code class="notranslate"><i>string</i></code> |   <code class="notranslate">~</code> <code class="notranslate"><i>regex</i></code> ; </dt><dd>  文字字符串（1.9.12）或从服务器获取的数据应匹配的正则表达式。  使用前面的“ <code class="notranslate">~*</code> ”修饰符（对于不区分大小写的匹配）或“ <code class="notranslate">~</code> ”修饰符（对于区分大小写的匹配）指定正则表达式。 </dd></dl><p>   <code class="notranslate">send</code>和<code class="notranslate">expect</code>参数都可以包含十六进制文字，前缀为“ <code class="notranslate">\x</code> ”，后跟两个十六进制数字，例如“ <code class="notranslate">\x80</code> ”（1.9.12）。 </p><p>  在下列情况下通过健康检查 </p><ul class="compact"><li>   TCP连接成功建立; </li><li>   <code class="notranslate">send</code>参数中的<code class="notranslate"><i>string</i></code> （如果已指定）已发送; </li><li>  如果指定，从服务器获取的数据与<code class="notranslate">expect</code>参数中的字符串或正则表达式匹配; </li><li>  经过的时间不超过<a href="#health_check_timeout">health_check_timeout</a>指令中指定的值。 </li></ul><p></p><p>  例： </p><blockquote class="example"><pre class="notranslate">upstream backend {
    zone     upstream_backend 10m;
    server   127.0.0.1:12345;
}

match http {
    send     "GET / HTTP/1.0\r\nHost: localhost\r\n\r\n";
    expect ~ "200 OK";
}

server {
    listen       12346;
    proxy_pass   backend;
    health_check match=http;
}
</pre></blockquote><p></p><p></p><blockquote class="note">  仅检查从服务器获得的第一个<a href="ngx_stream_proxy_module.html#proxy_buffer_size">proxy_buffer_size</a>字节数据。 </blockquote><p></p> 
<span></span><div style="display: none;"></div></div>
</body>
</html>