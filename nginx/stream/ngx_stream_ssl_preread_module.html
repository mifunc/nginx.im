<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>stream/ngx_stream_ssl_preread_module-nginx中文手册</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="None"/>
<meta name="keywords" content="server,ssl,preread,192.168,0.1"/>
</head>
<body>
<div id="content"><h2 class="notranslate">Module ngx_stream_ssl_preread_module</h2><table width="100%"><tbody><tr><td align="left" class="notranslate"> <a href="#example">Example Configuration</a> <br> <a href="#directives">Directives</a> <br>     <a href="#ssl_preread">ssl_preread</a> <br> <a href="#variables">Embedded Variables</a> <br></td></tr></tbody></table><a name="summary"></a><p>   <code class="notranslate">ngx_stream_ssl_preread_module</code>模块（1.11.5）允许从<a href="https://tools.ietf.org/html/rfc5246#section-7.4.1.2">ClientHello</a>消息中提取信息而不终止SSL / TLS，例如，通过<a href="https://tools.ietf.org/html/rfc6066#section-3">SNI</a>请求的服务器名称或在<a href="https://tools.ietf.org/html/rfc7301">ALPN中</a>通告的协议。  默认情况下不构建此模块，应使用<code class="notranslate">--with-stream_ssl_preread_module</code>配置参数启用它。 </p><a name="example"></a><center><h4>  示例配置 </h4></center><p>  根据服务器名称选择上游： </p><blockquote class="example"><pre class="notranslate">map $ssl_preread_server_name $name {
    backend.example.com      backend;
    default                  backend2;
}

upstream backend {
    server 192.168.0.1:12345;
    server 192.168.0.2:12345;
}

upstream backend2 {
    server 192.168.0.3:12345;
    server 192.168.0.4:12345;
}

server {
    listen      12346;
    proxy_pass  $name;
    ssl_preread on;
}
</pre></blockquote><p></p><p>  根据协议选择上游： </p><blockquote class="example"><pre class="notranslate">map $ssl_preread_alpn_protocols $proxy {
    ~\bh2\b           127.0.0.1:8001;
    ~\bhttp/1.1\b     127.0.0.1:8002;
    ~\bxmpp-client\b  127.0.0.1:8003;
}

server {
    listen      9000;
    proxy_pass  $proxy;
    ssl_preread on;
}
</pre></blockquote><p></p><p>  根据SSL协议版本选择上游： </p><blockquote class="example"><pre class="notranslate">map $ssl_preread_protocol $upstream {
    ""        ssh.example.com:22;
    "TLSv1.2" new.example.com:443;
    default   tls.example.com:443;
}

# ssh and https on the same port
server {
    listen      192.168.0.1:443;
    proxy_pass  $upstream;
    ssl_preread on;
}
</pre></blockquote><p></p><a name="directives"></a><center><h4>  指令 </h4></center><a name="ssl_preread"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>ssl_preread</strong> <code class="notranslate">on</code> | <code class="notranslate">off</code> ;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            <pre class="notranslate">ssl_preread off;</pre>
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">stream</code> , <code class="notranslate">server</code> <br>
                </td></tr></tbody></table></div><p>  允许在<a href="stream_processing.html#preread_phase">预读</a>阶段从ClientHello消息中提取信息。 </p><a name="variables"></a><center><h4>  嵌入式变量 </h4></center><p></p><dl class="compact"><dt id="var_ssl_preread_protocol"> <code class="notranslate">$ssl_preread_protocol</code> </dt> <dd>  客户端支持的最高SSL协议版本（1.15.2） </dd><dt id="var_ssl_preread_server_name"> <code class="notranslate">$ssl_preread_server_name</code> </dt> <dd>  通过SNI请求的服务器名称 </dd><dt id="var_ssl_preread_alpn_protocols"> <code class="notranslate">$ssl_preread_alpn_protocols</code> </dt> <dd>  客户端通过ALPN（1.13.10）公布的协议列表。  值以逗号分隔。 </dd></dl><p></p> 
<span></span><div style="display: none;"></div></div>
</body>
</html>