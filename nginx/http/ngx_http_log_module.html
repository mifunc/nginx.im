<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>http/ngx_http_log_module-nginx中文手册</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="None"/>
<meta name="keywords" content="log,access,combined,remote,user"/>
</head>
<body>
<div id="content"><h2 class="notranslate">Module ngx_http_log_module</h2><table width="100%"><tbody><tr><td align="left" class="notranslate"> <a href="#example">Example Configuration</a> <br> <a href="#directives">Directives</a> <br>     <a href="#access_log">access_log</a> <br>     <a href="#log_format">log_format</a> <br>     <a href="#open_log_file_cache">open_log_file_cache</a> <br></td></tr></tbody></table><a name="summary"></a><p>   <code class="notranslate">ngx_http_log_module</code>模块以指定的格式写入请求日志。 </p><p>  请求记录在处理结束的位置的上下文中。  如果在请求处理期间发生<a href="ngx_http_core_module.html#internal">内部重定向</a> ，则它可能与原始位置不同。 </p><a name="example"></a><center><h4>  示例配置 </h4></center><p></p><blockquote class="example"><pre class="notranslate">log_format compression '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $bytes_sent '
                       '"$http_referer" "$http_user_agent" "$gzip_ratio"';

access_log /spool/logs/nginx-access.log compression buffer=32k;
</pre></blockquote><p></p><a name="directives"></a><center><h4>  指令 </h4></center><a name="access_log"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>access_log</strong> 
    <code class="notranslate"><i>path</i></code>
    [ <code class="notranslate"><i>format</i></code>
    [ <code class="notranslate">buffer</code> = <code class="notranslate"><i>size</i></code> ]
    [ <code class="notranslate">gzip[= <code class="notranslate"><i>level</i></code> ]</code> ]
    [ <code class="notranslate">flush</code> = <code class="notranslate"><i>time</i></code> ]
    [ <code class="notranslate">if</code> = <code class="notranslate"><i>condition</i></code> ]];</code> <br> <code class="notranslate"><strong>access_log</strong> <code class="notranslate">off</code> ;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            <pre class="notranslate">access_log logs/access.log combined;</pre>
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">http</code> , <code class="notranslate">server</code> , <code class="notranslate">location</code> , <code class="notranslate">if in location</code> , <code class="notranslate">limit_except</code> <br>
                </td></tr></tbody></table></div><p>  设置缓冲日志写入的路径，格式和配置。  可以在同一级别指定多个日志。  可以通过在第一个参数中指定“ <code class="notranslate">syslog:</code> ”前缀来配置记录到<a href="syslog.html">syslog</a> 。  特殊值<code class="notranslate">off</code>取消当前级别的所有<code class="notranslate">access_log</code>指令。  如果未指定格式，则使用预定义的“ <code class="notranslate">combined</code> ”格式。 </p><p>  如果使用<code class="notranslate">buffer</code>或<code class="notranslate">gzip</code> （1.3.10,1.2.7）参数，则将缓冲写入日志。 </p><blockquote class="note">  缓冲区大小不得超过磁盘文件的原子写入大小。  对于FreeBSD，这个大小是无限的。 </blockquote><p></p><p>  启用缓冲后，数据将写入文件： </p><ul class="compact"><li>  如果下一个日志行不适合缓冲区; </li><li>  如果缓冲的数据早于<code class="notranslate">flush</code>参数（1.3.10,1.2.7）指定的数据; </li><li>  当工作进程<a href="control.html">重新打开</a>日志文件或正在关闭时。 </li></ul><p></p><p>  如果使用<code class="notranslate">gzip</code>参数，则在写入文件之前将压缩缓冲的数据。  压缩级别可以设置为1（最快，压缩较少）和9（最慢，最佳压缩）。  默认情况下，缓冲区大小等于64K字节，压缩级别设置为1.由于数据是以原子块压缩的，因此日志文件可以随时通过“ <code class="notranslate">zcat</code> ”解压缩或读取。 </p><p>  例： </p><blockquote class="example"><pre class="notranslate">access_log /path/to/log.gz combined gzip flush=5m;
</pre></blockquote><p></p><p></p><blockquote class="note">  要使gzip压缩起作用，必须使用zlib库构建nginx。 </blockquote><p></p><p>  文件路径可以包含变量（0.7.6+），但是这样的日志有一些约束： </p><ul class="compact"><li>  工作进程使用其凭据的<a href="ngx_core_module.html#user">用户</a>应具有在具有此类日志的目录中创建文件的权限; </li><li>  缓冲写入不起作用; </li><li>  每个日志写入都会打开和关闭该文件。  但是，由于常用文件的描述符可以存储在<a href="#open_log_file_cache">缓存中</a> ，因此写入旧文件可以在<a href="#open_log_file_cache">open_log_file_cache</a>指令的<code class="notranslate">valid</code>参数指定的时间内继续写入 </li><li>  在每个日志写入期间，检查是否存在请求的<a href="ngx_http_core_module.html#root">根目录</a> ，如果它不存在，则不会创建日志。  因此，在同一级别指定<a href="ngx_http_core_module.html#root">root</a>和<code class="notranslate">access_log</code>是个好主意： <blockquote class="example"><pre class="notranslate">server {
    root       /spool/vhost/data/$host;
    access_log /spool/vhost/logs/$host;
    ...
</pre></blockquote></li></ul><p></p><p>   <code class="notranslate">if</code>参数（1.7.0）启用条件记录。  如果<code class="notranslate"><i>condition</i></code>评估为“0”或空字符串，则不会记录请求。  在以下示例中，将不记录响应代码为2xx和3xx的请求： </p><blockquote class="example"><pre class="notranslate">map $status $loggable {
    ~^[23]  0;
    default 1;
}

access_log /path/to/access.log combined if=$loggable;
</pre></blockquote><p></p><a name="log_format"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>log_format</strong> 
    <code class="notranslate"><i>name</i></code>
    [ <code class="notranslate">escape</code> = <code class="notranslate">default</code> | <code class="notranslate">json</code> | <code class="notranslate">none</code> ]
    <code class="notranslate"><i>string</i></code> ...;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            <pre class="notranslate">log_format combined "...";</pre>
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">http</code> <br>
                </td></tr></tbody></table></div><p>  指定日志格式。 </p><a name="log_format_escape"></a><p>   <code class="notranslate">escape</code>参数（1.11.8）允许设置在变量中转义的<code class="notranslate">json</code>或<code class="notranslate">default</code>字符，默认情况下，使用<code class="notranslate">default</code>转义。   <code class="notranslate">none</code>值（1.13.10）禁用转义。 </p><p>  日志格式可以包含公共变量，以及仅在日志写入时存在的变量： </p><dl class="compact"><dt id="var_bytes_sent"> <code class="notranslate">$bytes_sent</code> </dt> <dd>  发送到客户端的字节数 </dd><dt id="var_connection"> <code class="notranslate">$connection</code> </dt> <dd>  连接序列号 </dd><dt id="var_connection_requests"> <code class="notranslate">$connection_requests</code> </dt> <dd>  通过连接发出的当前请求数（1.1.18） </dd><dt id="var_msec"> <code class="notranslate">$msec</code> </dt> <dd>  以秒为单位的时间，日志写入时的分辨率为毫秒 </dd><dt id="var_pipe"> <code class="notranslate">$pipe</code> </dt> <dd>   “ <code class="notranslate">p</code> ”如果请求是流水线的，“ <code class="notranslate">.</code>   “ 除此以外 </dd><dt id="var_request_length"> <code class="notranslate">$request_length</code> </dt> <dd>  请求长度（包括请求行，标题和请求正文） </dd><dt id="var_request_time"> <code class="notranslate">$request_time</code> </dt> <dd>  以毫秒为单位请求处理时间（以秒为单位）;  从客户端读取第一个字节之间经过的时间，并将最后一个字节发送到客户端后的日志写入 </dd><dt id="var_status"> <code class="notranslate">$status</code> </dt> <dd>  回应状态 </dd><dt id="var_time_iso8601"> <code class="notranslate">$time_iso8601</code> </dt> <dd>  当地时间采用ISO 8601标准格式 </dd><dt id="var_time_local"> <code class="notranslate">$time_local</code> </dt> <dd>  通用日志格式的本地时间 </dd></dl><p></p><blockquote class="note">  在现代nginx版本变量<a href="ngx_http_core_module.html#var_status">$ status</a> （ <a href="ngx_http_core_module.html#var_bytes_sent">1.3.2,1.2.2</a> ）， <a href="ngx_http_core_module.html#var_bytes_sent">$ bytes_sent</a> （ <a href="ngx_http_core_module.html#var_bytes_sent">1.3.8,1.2.5</a> ）， <a href="ngx_http_core_module.html#var_connection">$ connection</a> （ <a href="ngx_http_core_module.html#var_bytes_sent">1.3.8,1.2.5</a> ）， <a href="ngx_http_core_module.html#var_connection">$ connection_requests</a> （ <a href="ngx_http_core_module.html#var_bytes_sent">1.3.8,1.2</a> ） .5）， <a href="ngx_http_core_module.html#var_msec">$ msec</a> （1.3.9,1.2.6）， <a href="ngx_http_core_module.html#var_request_time">$ request_time</a> （1.3.9,1.2.6）， <a href="ngx_http_core_module.html#var_pipe">$ pipe</a> （1.3.12,1.2.7）， <a href="ngx_http_core_module.html#var_request_length">$ request_length</a> （1.3.12,1.2.7） ）， <a href="ngx_http_core_module.html#var_time_iso8601">$ time_iso8601</a> （ <a href="ngx_http_core_module.html#var_time_iso8601">1.3.12,1.2.7</a> ）和<a href="ngx_http_core_module.html#var_time_local">$ time_local</a> （1.3.12,1.2.7）也可用作公共变量。 </blockquote><p></p><p>  发送到客户端的标题行具有前缀“ <code class="notranslate">sent_http_</code> ”，例如<code class="notranslate">$sent_http_content_range</code> 。 </p><p>  配置始终包含预定义的“ <code class="notranslate">combined</code> ”格式： </p><blockquote class="example"><pre class="notranslate">log_format combined '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';
</pre></blockquote><p></p><a name="open_log_file_cache"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>open_log_file_cache</strong> 
<code class="notranslate">max</code> = <code class="notranslate"><i>N</i></code>
[ <code class="notranslate">inactive</code> = <code class="notranslate"><i>time</i></code> ]
[ <code class="notranslate">min_uses</code> = <code class="notranslate"><i>N</i></code> ]
[ <code class="notranslate">valid</code> = <code class="notranslate"><i>time</i></code> ];</code> <br> <code class="notranslate"><strong>open_log_file_cache</strong> <code class="notranslate">off</code> ;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            <pre class="notranslate">open_log_file_cache off;</pre>
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">http</code> , <code class="notranslate">server</code> , <code class="notranslate">location</code> <br>
                </td></tr></tbody></table></div><p>  定义一个缓存，用于存储名称中包含变量的常用日志的文件描述符。  该指令具有以下参数： </p><dl class="compact"><dt> <code class="notranslate">max</code> </dt> <dd>  设置缓存中的最大描述符数;  如果缓存变满，则最近最少使用（LRU）描述符将被关闭 </dd><dt> <code class="notranslate">inactive</code> </dt> <dd>  如果在此期间没有访问权限，则设置关闭缓存描述符的时间;  默认情况下，10秒 </dd><dt> <code class="notranslate">min_uses</code> </dt> <dd>  设置在<code class="notranslate">inactive</code>参数定义的时间内使文件使用的最小数量，以使描述符在缓存中保持打开状态;  默认情况下，1 </dd><dt> <code class="notranslate">valid</code> </dt> <dd>  设置应该检查文件是否仍然存在同名的时间;  默认情况下，60秒 </dd><dt> <code class="notranslate">off</code> </dt> <dd>  禁用缓存 </dd></dl><p></p><p>  用法示例： </p><blockquote class="example"><pre class="notranslate">open_log_file_cache max=1000 inactive=20s valid=1m min_uses=2;
</pre></blockquote><p></p> 
<span></span><div style="display: none;"></div></div>
</body>
</html>