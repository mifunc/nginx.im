<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>http/ngx_http_limit_conn_module-nginx中文手册</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="None"/>
<meta name="keywords" content="limit,conn,zone,addr,10m"/>
</head>
<body>
<div id="content"><h2 class="notranslate">Module ngx_http_limit_conn_module</h2><table width="100%"><tbody><tr><td align="left" class="notranslate"> <a href="#example">Example Configuration</a> <br> <a href="#directives">Directives</a> <br>     <a href="#limit_conn">limit_conn</a> <br>     <a href="#limit_conn_log_level">limit_conn_log_level</a> <br>     <a href="#limit_conn_status">limit_conn_status</a> <br>     <a href="#limit_conn_zone">limit_conn_zone</a> <br>     <a href="#limit_zone">limit_zone</a> <br></td></tr></tbody></table><a name="summary"></a><p>   <code class="notranslate">ngx_http_limit_conn_module</code>模块用于限制每个定义密钥的连接数，特别是来自单个IP地址的连接数。 </p><p>  并非所有连接都被计算在内  仅当连接具有服务器正在处理的请求并且已经读取了整个请求标头时才计算连接。 </p><a name="example"></a><center><h4>  示例配置 </h4></center><p></p><blockquote class="example"><pre class="notranslate">http {
    limit_conn_zone $binary_remote_addr zone=addr:10m;

    ...

    server {

        ...

        location /download/ {
            limit_conn addr 1;
        }
</pre></blockquote><p></p><a name="directives"></a><center><h4>  指令 </h4></center><a name="limit_conn"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>limit_conn</strong> <code class="notranslate"><i>zone</i></code> <code class="notranslate"><i>number</i></code> ;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            
            —
        
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">http</code> , <code class="notranslate">server</code> , <code class="notranslate">location</code> <br>
                </td></tr></tbody></table></div><p>  设置共享内存区域和给定键值的最大允许连接数。  超过此限制时，服务器将返回<a href="#limit_conn_status">错误</a>以回复请求。  例如，指令 </p><blockquote class="example"><pre class="notranslate">limit_conn_zone $binary_remote_addr zone=addr:10m;

server {
    location /download/ {
        limit_conn addr 1;
    }
</pre></blockquote><p>  每次只允许一个IP地址连接一个。 </p><blockquote class="note">  在HTTP / 2和SPDY中，每个并发请求被视为单独的连接。 </blockquote><p></p><p>  可能有几个<code class="notranslate">limit_conn</code>指令。  例如，以下配置将限制每个客户端IP与服务器的连接数，同时限制与虚拟服务器的连接总数： </p><blockquote class="example"><pre class="notranslate">limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;

server {
    ...
    limit_conn perip 10;
    limit_conn perserver 100;
}
</pre></blockquote><p></p><p>  当且仅当当前级别上没有<code class="notranslate">limit_conn</code>指令时，这些指令才从前一级继承。 </p><a name="limit_conn_log_level"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>limit_conn_log_level</strong> 
<code class="notranslate">info</code> |
<code class="notranslate">notice</code> |
<code class="notranslate">warn</code> |
<code class="notranslate">error</code> ;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            <pre class="notranslate">limit_conn_log_level error;</pre>
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">http</code> , <code class="notranslate">server</code> , <code class="notranslate">location</code> <br>
                </td></tr></tbody></table><p>  该指令出现在0.8.18版本中。 </p></div><p>  为服务器限制连接数的情况设置所需的日志记录级别。 </p><a name="limit_conn_status"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>limit_conn_status</strong> <code class="notranslate"><i>code</i></code> ;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            <pre class="notranslate">limit_conn_status 503;</pre>
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">http</code> , <code class="notranslate">server</code> , <code class="notranslate">location</code> <br>
                </td></tr></tbody></table><p>  该指令出现在1.3.15版本中。 </p></div><p>  设置要响应拒绝的请求而返回的状态代码。 </p><a name="limit_conn_zone"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>limit_conn_zone</strong> 
    <code class="notranslate"><i>key</i></code>
    <code class="notranslate">zone</code> = <code class="notranslate"><i>name</i></code> : <code class="notranslate"><i>size</i></code> ;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            
            —
        
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">http</code> <br>
                </td></tr></tbody></table></div><p>  设置共享内存区域的参数，该区域将保留各种键的状态。  特别是，状态包括当前的连接数。   <code class="notranslate"><i>key</i></code>可以包含文本，变量及其组合。  具有空键值的请求不计算在内。 </p><blockquote class="note">  在1.7.6版之前， <code class="notranslate"><i>key</i></code>可以只包含一个变量。 </blockquote><p>  用法示例： </p><blockquote class="example"><pre class="notranslate">limit_conn_zone $binary_remote_addr zone=addr:10m;
</pre></blockquote><p>  这里，客户端IP地址用作密钥。  请注意，此处使用<code class="notranslate">$binary_remote_addr</code>变量而不是<code class="notranslate">$remote_addr</code> 。   <code class="notranslate">$remote_addr</code>变量的大小可以在7到15个字节之间变化。  存储状态在32位平台上占用32或64字节的内存，在64位平台上占用64字节。  对于IPv4地址， <code class="notranslate">$binary_remote_addr</code>变量的大小始终为4个字节，对于IPv6地址，则为16个字节。  存储状态在32位平台上总是占用32或64字节，在64位平台上占用64字节。  一兆字节区域可以保留大约32,000个32字节状态或大约16,000个64字节状态。  如果区域存储空间耗尽，服务器将向所有其他请求返回<a href="#limit_conn_status">错误</a> 。 </p><a name="limit_zone"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>limit_zone</strong> 
    <code class="notranslate"><i>name</i></code>
    <code class="notranslate"><i>$variable</i></code>
    <code class="notranslate"><i>size</i></code> ;</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            
            —
        
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">http</code> <br>
                </td></tr></tbody></table></div><p>  该指令在1.1.8版本中已过时，已在1.7.6版本中删除。  应使用具有更改语法的等效<a href="#limit_conn_zone">limit_conn_zone</a>指令： </p><blockquote class="note">   <code class="notranslate">limit_conn_zone</code> <code class="notranslate"><i>$variable</i></code> <code class="notranslate">zone</code> = <code class="notranslate"><i>name</i></code> ： <code class="notranslate"><i>size</i></code> ; </blockquote><p></p> 
<span></span><div style="display: none;"></div></div>
</body>
</html>