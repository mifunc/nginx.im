<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>http/websocket-nginx中文手册</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="None"/>
<meta name="keywords" content="proxy,http,upgrade,set,header"/>
</head>
<body>
<div id="content"><h2>   WebSocket代理 </h2><p>  要将客户端和服务器之间的连接从HTTP / 1.1转换为WebSocket，请使用HTTP / 1.1中提供的<a href="https://tools.ietf.org/html/rfc2616#section-14.42">协议交换</a>机制。 </p><p>  然而，有一个微妙之处：由于“升级”是<a href="https://tools.ietf.org/html/rfc2616#section-13.5.1">逐跳</a>标头，因此它不会从客户端传递到代理服务器。  使用正向代理，客户端可以使用<code class="notranslate">CONNECT</code>方法来规避此问题。  但是，这不适用于反向代理，因为客户端不知道任何代理服务器，并且需要在代理服务器上进行特殊处理。 </p><p>  从版本1.3.13开始，nginx实现了特殊的操作模式，如果代理服务器返回带有代码101（交换协议）的响应，则允许在客户端和代理服务器之间建立隧道，并且客户端要求通过请求中的“升级”标头。 </p><p>  如上所述，包括“升级”和“连接”的逐跳头不会从客户端传递到代理服务器，因此为了让代理服务器知道客户端将协议切换到WebSocket的意图，这些头必须明确传递： </p><blockquote class="example"><pre class="notranslate">location /chat/ {
    proxy_pass http://backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
</pre></blockquote><p>  一个更复杂的示例，其中对代理服务器的请求中的“连接”头字段的值取决于客户端请求头中是否存在“升级”字段： </p><blockquote class="example"><pre class="notranslate">http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        ...

        location /chat/ {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }
</pre></blockquote><p></p><p>  默认情况下，如果代理服务器在60秒内未传输任何数据，则将关闭连接。  使用<a href="ngx_http_proxy_module.html#proxy_read_timeout">proxy_read_timeout</a>指令可以增加此超时。  或者，代理服务器可以配置为定期发送WebSocket ping帧以重置超时并检查连接是否仍然存在。 </p> 
<span></span><div style="display: none;"></div></div>
</body>
</html>