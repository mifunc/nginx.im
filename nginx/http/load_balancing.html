<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>http/load_balancing-nginx中文手册</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="None"/>
<meta name="keywords" content="server,example,com,myapp1,upstream"/>
</head>
<body>
<div id="content"><h2>  使用nginx作为HTTP负载均衡器 </h2><table width="100%"><tbody><tr><td align="left" class="notranslate"> <a href="#nginx_load_balancing_methods">Load balancing methods</a> <br> <a href="#nginx_load_balancing_configuration">Default load balancing configuration</a> <br> <a href="#nginx_load_balancing_with_least_connected">Least connected load balancing</a> <br> <a href="#nginx_load_balancing_with_ip_hash">Session persistence</a> <br> <a href="#nginx_weighted_load_balancing">Weighted load balancing</a> <br> <a href="#nginx_load_balancing_health_checks">Health checks</a> <br> <a href="#nginx_load_balancing_additional_information">Further reading</a> <br></td></tr></tbody></table><center><h4>  介绍 </h4></center><p>  跨多个应用程序实例的负载平衡是一种常用技术，用于优化资源利用率，最大化吞吐量，减少延迟并确保容错配置。 </p><p>  可以使用nginx作为非常有效的HTTP负载平衡器，将流量分配到多个应用程序服务器，并使用nginx提高Web应用程序的性能，可伸缩性和可靠性。 </p><a name="nginx_load_balancing_methods"></a><center><h4>  负载均衡方法 </h4></center><p>   nginx支持以下负载平衡机制（或​​方法）： </p><ul><li>  循环 - 对应用程序服务器的请求以循环方式分发， </li><li>  最少连接 - 下一个请求被分配给活动连接数最少的服务器， </li><li>   ip-hash  - 哈希函数用于确定应为下一个请求选择哪个服务器（基于客户端的IP地址）。 </li></ul><p></p><a name="nginx_load_balancing_configuration"></a><center><h4>  默认负载均衡配置 </h4></center><p>  使用nginx进行负载平衡的最简单配置可能如下所示： </p><blockquote class="example"><pre class="notranslate">http {
    upstream myapp1 {
        server srv1.example.com;
        server srv2.example.com;
        server srv3.example.com;
    }

    server {
        listen 80;

        location / {
            proxy_pass http://myapp1;
        }
    }
}
</pre></blockquote><p></p><p>  在上面的示例中，在srv1-srv3上运行了3个相同应用程序的实例。  如果未特别配置负载平衡方法，则默认为循环。  所有请求都<a href="ngx_http_proxy_module.html#proxy_pass">代理</a>到服务器组myapp1，nginx应用HTTP负载平衡来分发请求。 </p><p>   nginx中的反向代理实现包括HTTP，HTTPS，FastCGI，uwsgi，SCGI，memcached和gRPC的负载平衡。 </p><p>  要为HTTPS而不是HTTP配置负载平衡，只需使用“https”作为协议。 </p><p>  为FastCGI，uwsgi，SCGI，memcached或gRPC设置负载平衡时，分别使用<a href="ngx_http_fastcgi_module.html#fastcgi_pass">fastcgi_pass</a> ， <a href="ngx_http_uwsgi_module.html#uwsgi_pass">uwsgi_pass</a> ， <a href="ngx_http_scgi_module.html#scgi_pass">scgi_pass</a> ， <a href="ngx_http_memcached_module.html#memcached_pass">memcached_pa​​ss</a>和<a href="ngx_http_grpc_module.html#grpc_pass">grpc_pass</a>指令。 </p><a name="nginx_load_balancing_with_least_connected"></a><center><h4>  最小连接负载平衡 </h4></center><p>  另一个负载平衡规则是最少连接的。  在某些请求需要更长时间才能完成的情况下，最小连接允许更公平地控制应用程序实例上的负载。 </p><p>  使用最少连接的负载平衡，nginx将尽量不会使繁忙的应用程序服务器过载请求，而是将新请求分发给不太繁忙的服务器。 </p><p>  当<a href="ngx_http_upstream_module.html#least_conn">least_conn</a>指令用作服务器组配置的一部分时，将激活nginx中的最小连接负载平衡： </p><blockquote class="example"><pre class="notranslate">    upstream myapp1 {
        least_conn;
        server srv1.example.com;
        server srv2.example.com;
        server srv3.example.com;
    }
</pre></blockquote><p></p><a name="nginx_load_balancing_with_ip_hash"></a><center><h4>  会话持久性 </h4></center><p>  请注意，通过循环或最少连接的负载平衡，每个后续客户端的请求可能会分发到不同的服务器。  无法保证同一客户端始终指向同一服务器。 </p><p>  如果需要将客户端绑定到特定的应用程序服务器 - 换句话说，就始终尝试选择特定服务器而言，使客户端的会话“粘滞”或“持久” -  ip-hash负载平衡机制可以是用过的。 </p><p>  使用ip-hash，客户端的IP地址将用作散列密钥，以确定应为客户端的请求选择服务器组中的哪个服务器。  此方法可确保来自同一客户端的请求始终定向到同一服务器，但此服务器不可用时除外。 </p><p>  要配置ip-hash负载平衡，只需将<a href="ngx_http_upstream_module.html#ip_hash">ip_hash</a>指令添加到服务器（上游）组配置： </p><blockquote class="example"><pre class="notranslate">upstream myapp1 {
    ip_hash;
    server srv1.example.com;
    server srv2.example.com;
    server srv3.example.com;
}
</pre></blockquote><p></p><a name="nginx_weighted_load_balancing"></a><center><h4>  加权负载平衡 </h4></center><p>  通过使用服务器权重，甚至可以进一步影响nginx负载平衡算法。 </p><p>  在上面的示例中，未配置服务器权重，这意味着所有指定的服务器都被视为对特定负载平衡方法具有同等资格。 </p><p>  特别是对于循环，它还意味着在服务器上或多或少地平等分配请求 - 只要有足够的请求，并且以统一的方式处理请求并且足够快地完成。 </p><p>  当为服务器指定<a href="ngx_http_upstream_module.html#server">权重</a>参数时， <a href="ngx_http_upstream_module.html#server">权</a>重被计入负载平衡决策的一部分。 </p><blockquote class="example"><pre class="notranslate">    upstream myapp1 {
        server srv1.example.com weight=3;
        server srv2.example.com;
        server srv3.example.com;
    }
</pre></blockquote><p></p><p>  使用此配置，每5个新请求将分布在应用程序实例中，如下所示：3个请求将定向到srv1，一个请求将转到srv2，另一个请求转到srv3。 </p><p>  同样可以在最近的nginx版本中使用具有最少连接和ip-hash负载平衡的权重。 </p><a name="nginx_load_balancing_health_checks"></a><center><h4>  健康检查 </h4></center><p>   nginx中的反向代理实现包括带内（或被动）服务器运行状况检查。  如果来自特定服务器的响应失败并显示错误，则nginx会将此服务器标记为失败，并将尝试避免为后续入站请求选择此服务器一段时间。 </p><p>   <a href="ngx_http_upstream_module.html#server">max_fails</a>指令设置在<a href="ngx_http_upstream_module.html#server">fail_timeout</a>期间应该发生的与服务器通信的连续不成功尝试次数。  默认情况下， <a href="ngx_http_upstream_module.html#server">max_fails</a>设置为1.当设置为0时，将禁用此服务器的运行状况检查。   <a href="ngx_http_upstream_module.html#server">fail_timeout</a>参数还定义服务器将标记为失败的时间。  在服务器发生故障后的<a href="ngx_http_upstream_module.html#server">fail_timeout</a>时间间隔后，nginx将开始使用实时客户端的请求正常探测服务器。  如果探测成功，则将服务器标记为实时。 </p><a name="nginx_load_balancing_additional_information"></a><center><h4>  进一步阅读 </h4></center><p>  此外，还有更多指令和参数可以控制nginx中的服务器负载平衡，例如<a href="ngx_http_proxy_module.html#proxy_next_upstream">proxy_next_upstream</a> ， <a href="ngx_http_upstream_module.html#server">backup</a> ， <a href="ngx_http_upstream_module.html#server">down</a>和<a href="ngx_http_upstream_module.html#keepalive">keepalive</a> 。  有关更多信息，请查看我们的<a href="..">参考文档</a> 。 </p><p>  最后但同样重要的是， <a href="https://www.nginx.com/products/application-load-balancing/">应用程序负载平衡</a> ， <a href="https://www.nginx.com/products/application-health-checks/">应用程序运行状况检查</a> ， <a href="https://www.nginx.com/products/live-activity-monitoring/">活动监视</a>和服务器组的动态<a href="https://www.nginx.com/products/on-the-fly-reconfiguration/">重新配置</a>是我们付费NGINX Plus订阅的一部分。 </p><p>  以下文章更详细地描述了与NGINX Plus的负载平衡： </p><ul><li>   <a href="https://www.nginx.com/blog/load-balancing-with-nginx-plus/">使用NGINX和NGINX Plus进行负载均衡</a> </li><li>   <a href="https://www.nginx.com/blog/load-balancing-with-nginx-plus-part2/">使用NGINX和NGINX Plus第2部分进行负载平衡</a> </li></ul><p></p> 
<span></span><div style="display: none;"></div></div>
</body>
</html>