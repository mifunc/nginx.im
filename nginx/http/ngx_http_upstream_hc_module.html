<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>http/ngx_http_upstream_hc_module-nginx中文手册</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="None"/>
<meta name="keywords" content="server,status,match,example,com"/>
</head>
<body>
<div id="content"><h2 class="notranslate">Module ngx_http_upstream_hc_module</h2><table width="100%"><tbody><tr><td align="left" class="notranslate"> <a href="#example">Example Configuration</a> <br> <a href="#directives">Directives</a> <br>     <a href="#health_check">health_check</a> <br>     <a href="#match">match</a> <br></td></tr></tbody></table><a name="summary"></a><p>   <code class="notranslate">ngx_http_upstream_hc_module</code>模块允许对周围位置中引用的<a href="ngx_http_upstream_module.html#upstream">组</a>中的服务器进行定期运行状况检查。  服务器组必须驻留在<a href="ngx_http_upstream_module.html#zone">共享内存中</a> 。 </p><p>  如果运行状况检查失败，则服务器将被视为运行状况不佳。  如果为同一组服务器定义了多个运行状况检查，则任何检查的单个故障都将使相应的服务器被视为不健康。  客户端请求不会传递到处于“检查”状态的不健康服务器和服务器。 </p><p></p><blockquote class="note">  请注意，与健康检查一起使用时，大多数变量都将具有空值。 </blockquote><p></p><p></p><blockquote class="note">  该模块作为我们<a href="http://nginx.com/products/">商业订阅的</a>一部分提供。 </blockquote><p></p><a name="example"></a><center><h4>  示例配置 </h4></center><p></p><blockquote class="example"><pre class="notranslate">upstream dynamic {
    zone upstream_dynamic 64k;

    server backend1.example.com      weight=5;
    server backend2.example.com:8080 fail_timeout=5s slow_start=30s;
    server 192.0.2.1                 max_fails=3;

    server backup1.example.com:8080  backup;
    server backup2.example.com:8080  backup;
}

server {
    location / {
        proxy_pass http://dynamic;
        health_check;
    }
}
</pre></blockquote><p>  使用此配置，nginx将每隔五秒向<code class="notranslate">backend</code>组中的每个服务器发送“ <code class="notranslate">/</code> ”请求。  如果发生任何通信错误或超时，或者代理服务器使用2xx或3xx以外的状态代码进行响应，运行状况检查将失败，并且服务器将被视为运行状况不佳。 </p><p>  可以配置运行状况检查以测试响应的状态代码，某些标题字段及其值的存在以及正文内容。  测试使用<a href="#match">match</a>伪指令单独配置，并在<a href="#health_check">health_check</a>指令的<code class="notranslate">match</code>参数中引用： </p><blockquote class="example"><pre class="notranslate">http {
    server {
    ...
        location / {
            proxy_pass http://backend;
            health_check match=welcome;
        }
    }

    match welcome {
        status 200;
        header Content-Type = text/html;
        body ~ "Welcome to nginx!";
    }
}
</pre></blockquote><p>  此配置显示，为了通过运行状况检查，对运行状况检查请求的响应应该成功，状态为200，并包含“ <code class="notranslate">Welcome to nginx!</code>   “ 在身体里。 </p><a name="directives"></a><center><h4>  指令 </h4></center><a name="health_check"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>health_check</strong> [ <code class="notranslate"><i>parameters</i></code> ];</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            
            —
        
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">location</code> <br>
                </td></tr></tbody></table></div><p>  启用对周围位置中引用的<a href="ngx_http_upstream_module.html#upstream">组</a>中的服务器的定期运行状况检查。 </p><p>  支持以下可选参数： </p><dl class="compact"><dt id="health_check_interval">   <code class="notranslate">interval</code> = <code class="notranslate"><i>time</i></code> </dt><dd>  设置两次连续运行状况检查之间的间隔，默认为5秒。 </dd><dt id="health_check_jitter">   <code class="notranslate">jitter</code> = <code class="notranslate"><i>time</i></code> </dt><dd>  设置每个健康检查随机延迟的时间，默认情况下，没有延迟。 </dd><dt id="health_check_fails">   <code class="notranslate">fails</code> = <code class="notranslate"><i>number</i></code> </dt><dd>  设置特定服务器的连续失败运行状况检查的数量，在此之后，此服务器将被视为运行状况不佳，默认情况下为1。 </dd><dt id="health_check_passes">   <code class="notranslate">passes</code> = <code class="notranslate"><i>number</i></code> </dt><dd>  设置特定服务器的连续传递运行状况检查的数量，在此之后服务器将被视为运行状况，默认情况下为1。 </dd><dt id="health_check_uri">   <code class="notranslate">uri</code> = <code class="notranslate"><i>uri</i></code> </dt><dd>  定义健康检查请求中使用的URI，默认情况下为“ <code class="notranslate">/</code> ”。 </dd><dt id="health_check_mandatory"> <code class="notranslate">mandatory</code> </dt> <dd>  设置服务器的初始“检查”状态，直到第一次健康检查完成（1.11.7）。  客户端请求不会传递到处于“检查”状态的服务器。  如果未指定参数，则服务器最初将被视为健康。 </dd><dt id="health_check_match">   <code class="notranslate">match</code> = <code class="notranslate"><i>name</i></code> </dt><dd>  指定配置响应应传递的测试的<code class="notranslate">match</code>块，以便进行运行状况检查。  默认情况下，响应的状态代码应为2xx或3xx。 </dd><dt id="health_check_port">   <code class="notranslate">port</code> = <code class="notranslate"><i>number</i></code> </dt><dd>  定义连接到服务器以执行运行状况检查时使用的端口（1.9.7）。  默认情况下，等于<a href="ngx_http_upstream_module.html#server">服务器</a>端口。 </dd></dl><p></p><a name="match"></a><div class="directive"><table cellspacing="0"><tbody><tr><th class="notranslate">
            Syntax:
                </th><td class="notranslate">
            <code class="notranslate"><strong>match</strong> <code class="notranslate"><i>name</i></code> { ... }</code> <br>
                </td></tr><tr><th class="notranslate">
            Default:
                </th><td class="notranslate">
            
            —
        
                </td></tr><tr><th class="notranslate">
            Context:
                </th><td class="notranslate">
            <code class="notranslate">http</code> <br>
                </td></tr></tbody></table></div><p>  定义用于验证对运行状况检查请求的响应的命名测试集。 </p><p>  可以在响应中测试以下项目： </p><dl class="compact"><dt> <code class="notranslate">status 200;</code> </dt> <dd>  状态是200 </dd><dt> <code class="notranslate">status ! 500;</code> </dt> <dd>  状态不是500 </dd><dt> <code class="notranslate">status 200 204;</code> </dt> <dd>  状态为200或204 </dd><dt> <code class="notranslate">status ! 301 302;</code> </dt> <dd>  状态既不是301也不是302 </dd><dt> <code class="notranslate">status 200-399;</code> </dt> <dd>  状态在200到399之间 </dd><dt> <code class="notranslate">status ! 400-599;</code> </dt> <dd>  状态不在400到599之间 </dd><dt> <code class="notranslate">status 301-303 307;</code> </dt> <dd>  状态为301,302,303或307 </dd></dl><p></p><dl class="compact"><dt> <code class="notranslate">header Content-Type = text/html;</code> </dt> <dd>   header包含值为<code class="notranslate">text/html</code> “Content-Type” </dd><dt> <code class="notranslate">header Content-Type != text/html;</code> </dt> <dd>   header包含“Content-Type”，其值不是<code class="notranslate">text/html</code> </dd><dt> <code class="notranslate">header Connection ~ close;</code> </dt> <dd>   header包含“Connection”，其值与正则表达式<code class="notranslate">close</code>匹配 </dd><dt> <code class="notranslate">header Connection !~ close;</code> </dt> <dd>   header包含“Connection”，其值与正则表达式<code class="notranslate">close</code>不匹配 </dd><dt> <code class="notranslate">header Host;</code> </dt> <dd>  标头包含“主机” </dd><dt> <code class="notranslate">header ! X-Accel-Redirect;</code> </dt> <dd>  标头缺少“X-Accel-Redirect” </dd></dl><p></p><dl class="compact"><dt> <code class="notranslate">body ~ "Welcome to nginx!";</code> </dt> <dd>  正文表达“ <code class="notranslate">Welcome to nginx!</code>   ” </dd><dt> <code class="notranslate">body !~ "Welcome to nginx!";</code> </dt> <dd>  正文表达式不符合“ <code class="notranslate">Welcome to nginx!</code>   ” </dd></dl><p></p><p>  如果指定了多个测试，则响应仅在匹配所有测试时才匹配。 </p><blockquote class="note">  仅检查响应体的前256k。 </blockquote><p></p><p>  例子： </p><blockquote class="example"><pre class="notranslate"># status is 200, content type is "text/html",
# and body contains "Welcome to nginx!"
match welcome {
    status 200;
    header Content-Type = text/html;
    body ~ "Welcome to nginx!";
}
</pre></blockquote><p></p><blockquote class="example"><pre class="notranslate"># status is not one of 301, 302, 303, or 307, and header does not have "Refresh:"
match not_redirect {
    status ! 301-303 307;
    header ! Refresh;
}
</pre></blockquote><p></p><blockquote class="example"><pre class="notranslate"># status ok and not in maintenance mode
match server_ok {
    status 200-399;
    body !~ "maintenance mode";
}
</pre></blockquote><p></p> 
<span></span><div style="display: none;"></div></div>
</body>
</html>