<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>control-nginx中文手册</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="None"/>
<meta name="keywords" content="nginx,0.0,process,nobody,kqread"/>
</head>
<body>
<div id="content"><h2>  控制nginx </h2><table width="100%"><tbody><tr><td align="left" class="notranslate"> <a href="#reconfiguration">Changing Configuration</a> <br> <a href="#logs">Rotating Log-files</a> <br> <a href="#upgrade">Upgrading Executable on the Fly</a> <br></td></tr></tbody></table><p>   nginx可以用信号控制。  默认情况下，主进程的进程ID将写入文件<code class="notranslate">/usr/local/nginx/logs/nginx.pid</code> 。  此名称可以在配置时更改，也可以使用<a href="ngx_core_module.html#pid">pid</a>指令在<code class="notranslate">nginx.conf</code>更改。  主进程支持以下信号： </p><blockquote class="note"><table width="100%"><tbody><tr><td width="20%" class="notranslate">TERM, INT</td><td class="notranslate">fast shutdown</td></tr><tr><td width="20%" class="notranslate">QUIT</td><td class="notranslate">graceful shutdown</td></tr><tr><td width="20%" class="notranslate">HUP</td><td class="notranslate">changing configuration,
keeping up with a changed time zone (only for FreeBSD and Linux),
starting new worker processes with a new configuration,
graceful shutdown of old worker processes</td></tr><tr><td width="20%" class="notranslate">USR1</td><td class="notranslate">re-opening log files</td></tr><tr><td width="20%" class="notranslate">USR2</td><td class="notranslate">upgrading an executable file</td></tr><tr><td width="20%" class="notranslate">WINCH</td><td class="notranslate">graceful shutdown of worker processes</td></tr></tbody></table></blockquote><p></p><p>  虽然不是必需的，但也可以通过信号控制单个工作进程。  支持的信号是： </p><blockquote class="note"><table width="100%"><tbody><tr><td width="20%" class="notranslate">TERM, INT</td><td class="notranslate">fast shutdown</td></tr><tr><td width="20%" class="notranslate">QUIT</td><td class="notranslate">graceful shutdown</td></tr><tr><td width="20%" class="notranslate">USR1</td><td class="notranslate">re-opening log files</td></tr><tr><td width="20%" class="notranslate">WINCH</td><td class="notranslate">abnormal termination for debugging
(requires <a href="ngx_core_module.html#debug_points">debug_points</a> to be enabled)
</td></tr></tbody></table></blockquote><p></p><a name="reconfiguration"></a><center><h4>  改变配置 </h4></center><p>  为了让nginx重新读取配置文件，应该将HUP信号发送到主进程。  主进程首先检查语法有效性，然后尝试应用新配置，即打开日志文件和新的侦听套接字。  如果此操作失败，则会回滚更改并继续使用旧配置。  如果成功，它将启动新的工作进程，并向旧工作进程发送消息，请求它们正常关闭。  旧工作进程关闭侦听套接字并继续为旧客户端提供服务。  在为所有客户端提供服务后，将关闭旧工作进程。 </p><p>  让我们通过例子来说明这一点。  想象一下，nginx是在FreeBSD和命令上运行的 </p><blockquote class="example"><pre class="notranslate">ps axw -o pid,ppid,user,%cpu,vsz,wchan,command | egrep '(nginx|PID)'
</pre></blockquote><p>  产生以下输出： </p><blockquote class="example"><pre class="notranslate">  PID  PPID USER    %CPU   VSZ WCHAN  COMMAND
33126     1 root     0.0  1148 pause  nginx: master process /usr/local/nginx/sbin/nginx
33127 33126 nobody   0.0  1380 kqread nginx: worker process (nginx)
33128 33126 nobody   0.0  1364 kqread nginx: worker process (nginx)
33129 33126 nobody   0.0  1364 kqread nginx: worker process (nginx)
</pre></blockquote><p></p><p>  如果将HUP发送到主进程，则输出变为： </p><blockquote class="example"><pre class="notranslate">  PID  PPID USER    %CPU   VSZ WCHAN  COMMAND
33126     1 root     0.0  1164 pause  nginx: master process /usr/local/nginx/sbin/nginx
33129 33126 nobody   0.0  1380 kqread nginx: worker process is shutting down (nginx)
33134 33126 nobody   0.0  1368 kqread nginx: worker process (nginx)
33135 33126 nobody   0.0  1368 kqread nginx: worker process (nginx)
33136 33126 nobody   0.0  1368 kqread nginx: worker process (nginx)
</pre></blockquote><p></p><p>   PID 33129的旧工作进程之一仍然继续工作。  退出一段时间后： </p><blockquote class="example"><pre class="notranslate">  PID  PPID USER    %CPU   VSZ WCHAN  COMMAND
33126     1 root     0.0  1164 pause  nginx: master process /usr/local/nginx/sbin/nginx
33134 33126 nobody   0.0  1368 kqread nginx: worker process (nginx)
33135 33126 nobody   0.0  1368 kqread nginx: worker process (nginx)
33136 33126 nobody   0.0  1368 kqread nginx: worker process (nginx)
</pre></blockquote><p></p><a name="logs"></a><center><h4>  旋转日志文件 </h4></center><p>  为了旋转日志文件，需要先重命名它们。  之后，应将USR1信号发送到主进程。  然后，主进程将重新打开所有当前打开的日志文件，并为作为所有者的工作进程正在运行的非特权用户分配。  成功重新打开后，主进程将关闭所有打开的文件，并将消息发送到工作进程，要求他们重新打开文件。  工作进程还会立即打开新文件并关闭旧文件。  因此，旧文件几乎可立即用于后期处理，例如压缩。 </p><a name="upgrade"></a><center><h4>  即时升级可执行文件 </h4></center><p>  为了升级服务器可执行文件，应首先使用新的可执行文件代替旧文件。  之后，应将USR2信号发送到主进程。  主进程首先使用进程ID将其文件重命名为带有<code class="notranslate">.oldbin</code>后缀的新文件，例如<code class="notranslate">/usr/local/nginx/logs/nginx.pid.oldbin</code> ，然后启动一个新的可执行文件，该文件又启动新的工作进程： </p><blockquote class="example"><pre class="notranslate">  PID  PPID USER    %CPU   VSZ WCHAN  COMMAND
33126     1 root     0.0  1164 pause  nginx: master process /usr/local/nginx/sbin/nginx
33134 33126 nobody   0.0  1368 kqread nginx: worker process (nginx)
33135 33126 nobody   0.0  1380 kqread nginx: worker process (nginx)
33136 33126 nobody   0.0  1368 kqread nginx: worker process (nginx)
36264 33126 root     0.0  1148 pause  nginx: master process /usr/local/nginx/sbin/nginx
36265 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
36266 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
36267 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
</pre></blockquote><p></p><p>  之后，所有工作进程（新旧进程）继续接受请求。  如果将WINCH信号发送到第一个主进程，它将向其工作进程发送消息，请求它们正常关闭，然后它们将开始退出： </p><blockquote class="example"><pre class="notranslate">  PID  PPID USER    %CPU   VSZ WCHAN  COMMAND
33126     1 root     0.0  1164 pause  nginx: master process /usr/local/nginx/sbin/nginx
33135 33126 nobody   0.0  1380 kqread nginx: worker process is shutting down (nginx)
36264 33126 root     0.0  1148 pause  nginx: master process /usr/local/nginx/sbin/nginx
36265 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
36266 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
36267 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
</pre></blockquote><p></p><p>  一段时间后，只有新的工作进程才会处理请求： </p><blockquote class="example"><pre class="notranslate">  PID  PPID USER    %CPU   VSZ WCHAN  COMMAND
33126     1 root     0.0  1164 pause  nginx: master process /usr/local/nginx/sbin/nginx
36264 33126 root     0.0  1148 pause  nginx: master process /usr/local/nginx/sbin/nginx
36265 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
36266 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
36267 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
</pre></blockquote><p></p><p>  应该注意的是，旧的主进程不会关闭其侦听套接字，并且可以管理它以在需要时再次启动其工作进程。  如果由于某种原因新的可执行文件无法接受，可以执行以下操作之一： </p><ul class="compact"><li><p>  将HUP信号发送到旧的主进程。  旧的主进程将启动新的工作进程，而无需重新读取配置。  之后，通过将QUIT信号发送到新的主进程，可以正常关闭所有新进程。 </p></li><li><p>  将TERM信号发送到新的主进程。  然后它会向其工作进程发送一条消息，要求它们立即退出，并且它们几乎都会立即退出。   （如果新进程由于某种原因没有退出，则应将KILL信号发送给它们以强制它们退出。）当新的主进程退出时，旧的主进程将自动启动新的进程进程。 </p></li></ul><p></p><p>  如果新的主进程退出，则旧的主进程将使用进程ID从文件名中丢弃<code class="notranslate">.oldbin</code>后缀。 </p><p>  如果升级成功，则应将QUIT信号发送到旧的主进程，并且只保留新进程： </p><blockquote class="example"><pre class="notranslate">  PID  PPID USER    %CPU   VSZ WCHAN  COMMAND
36264     1 root     0.0  1148 pause  nginx: master process /usr/local/nginx/sbin/nginx
36265 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
36266 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
36267 36264 nobody   0.0  1364 kqread nginx: worker process (nginx)
</pre></blockquote><p></p> 
<span></span><div style="display: none;"></div></div>
</body>
</html>